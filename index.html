<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>AynÄ± Anda, AynÄ± Yerde</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#eee;
  font-family:Arial, sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.screen{display:none;text-align:center;max-width:500px;}
.screen.active{display:block;}
button{padding:14px 22px;margin:8px;font-size:20px;}
.timer{font-size:24px;margin-top:15px;}
.dark{animation:dark 3s infinite alternate;}
@keyframes dark{from{opacity:.4}to{opacity:1}}
</style>
</head>

<body>

<div id="lobby" class="screen active">
  <h1>AynÄ± Anda, AynÄ± Yerde</h1>
  <button onclick="createRoom()">Oda OluÅŸtur</button><br><br>
  <input id="roomInput" placeholder="Oda Kodu">
  <button onclick="joinRoom()">Odaya KatÄ±l</button>
</div>

<div id="room" class="screen">
  <h2>Oda</h2>
  <code id="roomCode"></code>
  <p>BaÄŸlanÄ±lÄ±yor...</p>
</div>

<div id="chapter4" class="screen dark">
  <h2>Sessizlik</h2>
  <p>Kelimeler yok. Sadece hisler kaldÄ±.</p>
  <button onclick="silentChoice('close')">ğŸ™‚</button>
  <button onclick="silentChoice('neutral')">ğŸ˜</button>
  <button onclick="silentChoice('away')">ğŸ™</button>
  <div class="timer" id="t4">8</div>
</div>

<div id="lost" class="screen">
  <h2>BaÄŸlantÄ± Koptu</h2>
</div>

<script>
const firebaseConfig={
  apiKey:"API_KEY",
  authDomain:"PROJECT_ID.firebaseapp.com",
  databaseURL:"https://PROJECT_ID-default-rtdb.firebaseio.com",
  projectId:"PROJECT_ID",
  storageBucket:"PROJECT_ID.appspot.com",
  messagingSenderId:"SENDER_ID",
  appId:"APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let roomId, playerId=Math.random().toString(36).substr(2,9);
let bond=0, timer;

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function createRoom(){
  roomId=Math.random().toString(36).substr(2,5).toUpperCase();
  db.ref("rooms/"+roomId).set({
    players:{[playerId]:true},
    chapter:4,
    data:{}
  });
  enterRoom();
}

function joinRoom(){
  roomId=roomInput.value.trim().toUpperCase();
  db.ref("rooms/"+roomId+"/players/"+playerId).set(true);
  enterRoom();
}

function enterRoom(){
  show("room");
  roomCode.innerText=roomId;
  const ref=db.ref("rooms/"+roomId);
  ref.on("value",snap=>{
    if(!snap.exists()) return show("lost");
    const d=snap.val();
    const pc=Object.keys(d.players||{}).length;
    if(pc===2 && d.chapter===4) start4();
  });
  db.ref("rooms/"+roomId+"/players/"+playerId).onDisconnect().remove();
}

/* CHAPTER 4 â€“ SESSÄ°ZLÄ°K */
function start4(){
  show("chapter4");
  let t=8; t4.innerText=t;
  timer=setInterval(()=>{
    t--; t4.innerText=t;
    if(t<=0){ clearInterval(timer); silentChoice("none"); }
  },1000);
}

function silentChoice(v){
  clearInterval(timer);
  db.ref(`rooms/${roomId}/data/c4/${playerId}`).set(v);
  db.ref(`rooms/${roomId}/data/c4`).once("value",s=>{
    if(Object.keys(s.val()||{}).length===2){
      const v=Object.values(s.val());
      if(v[0]==="close"&&v[1]==="close") bond+=3;
      else if(v.includes("close")&&v.includes("neutral")) bond+=1;
      else if(v.includes("away")) bond-=2;
      alert("Sessizlik bitti.\nBir ÅŸeyler hissedildi.");
    }
  });
}
</script>

</body>
</html>
